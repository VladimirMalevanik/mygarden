const q=new URLSearchParams(location.search);
const API=(q.get("api")||"http://127.0.0.1:8000").replace(/\/+$/,"");
document.getElementById("apiBase").textContent=API;
const $=id=>document.getElementById(id);const statusEl=$("status");let authed=false;
function setStatus(s){statusEl.textContent=s}
async function postForm(url,fields){const fd=new FormData();for(const[k,v]of Object.entries(fields))fd.append(k,v);const r=await fetch(url,{method:"POST",body:fd});if(!r.ok)throw new Error("HTTP "+r.status);return r.json()}
async function get(url){const r=await fetch(url);if(!r.ok)throw new Error("HTTP "+r.status);return r.json()}
async function postJSON(url,data){const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data||{})});if(!r.ok)throw new Error("HTTP "+r.status);return r.json()}
async function doHandshake(initData){const res=await postForm(`${API}/api/v1/tma/handshake`,{init_data:initData});authed=true;$("meBox").textContent=`streak:${res.streak} tz:${res.user.tz} coins:${res.user.coins}`;setStatus("online")}
$("btnHandshake").onclick=async()=>{try{const tg=window.Telegram?.WebApp;const initData=tg?.initData||"";if(!initData){alert("Запусти как Mini App в Telegram или ослабь проверку на бэке для локалки.");return}await doHandshake(initData)}catch(e){alert("Handshake failed: "+e.message)}};
async function refreshTasks(){if(!authed)return alert("Сначала handshake");const items=await get(`${API}/api/v1/tasks/instances`);const box=$("tasksBox");box.innerHTML="";items.forEach(it=>{const el=document.createElement("div");el.className="item";el.innerHTML=`<div><div>#${it.id} • ${it.status}</div><div class="badge">weight ${it.weight_cost} • tmpl ${it.template_id}</div></div><div class="row"><button class="btn" data-act="start">start</button><button class="btn primary" data-act="complete">complete</button></div>`;el.querySelector('[data-act="start"]').onclick=async()=>{await postJSON(`${API}/api/v1/tasks/instances/${it.id}/start`,{});await refreshTasks()};el.querySelector('[data-act="complete"]').onclick=async()=>{const focus=Number(prompt("focus_minutes?","25"))||0;const res=await postJSON(`${API}/api/v1/tasks/instances/${it.id}/complete`,{focus_minutes:focus});alert(`+XP ${res.xp_awarded} | progress ${res.progress_after}`);await refreshTasks()};box.appendChild(el)})}
$("btnRefreshTasks").onclick=refreshTasks;
$("btnCreateTpl").onclick=async()=>{if(!authed)return alert("Сначала handshake");const title=$("tplTitle").value.trim();const effort=Number($("tplEffort").value);const mode=$("tplMode").value;if(!title)return;const payload={title,category:"general",difficulty:2,effort_min_est:effort,mode,repeat_rule:"DAILY",planned_windows:"08:00-22:00"};const res=await postJSON(`${API}/api/v1/tasks/templates`,payload);$("tplMsg").textContent=`Создан шаблон #${res.id}`;await refreshTasks()};
async function refreshGarden(){if(!authed)return alert("Сначала handshake");const g=await get(`${API}/api/v1/garden`);const box=$("gardenBox");box.innerHTML=`<div class="muted">slots:${g.slots} moisture:${g.moisture} cleanliness:${g.cleanliness}</div>`;g.plants.forEach(p=>{const el=document.createElement("div");el.className="item";el.innerHTML=`<div>slot ${p.slot_index} • species ${p.species_id}</div><div class="badge">stage ${p.stage}, hp ${p.health}</div>`;box.appendChild(el)})}
$("btnGardenRefresh").onclick=refreshGarden;
$("btnPlant").onclick=async()=>{const slotIndex=Number($("slotIndex").value);const speciesId=Number($("speciesId").value);await postJSON(`${API}/api/v1/garden/plant`,{slot_index:slotIndex,species_id:speciesId});await refreshGarden()};
$("btnWater").onclick=async()=>{await postJSON(`${API}/api/v1/garden/water`,{});await refreshGarden()};
$("btnSummary").onclick=async()=>{if(!authed)return alert("Сначала handshake");const s=await get(`${API}/api/v1/daily/summary`);$("summaryBox").textContent=JSON.stringify(s,null,2)};
(function(){const tg=window.Telegram?.WebApp;if(!tg)return;tg.ready();setStatus("tma")})();
